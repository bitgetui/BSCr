<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delta Admin ‚Äî Support Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
--bg:#06080e;--bg2:#0f1319;--bg3:#161b24;--bg4:#1e2530;
--gold:#f0b90b;--gold2:#fcd535;--green:#0ecb81;--red:#f6465d;
--blue:#3b82f6;--purple:#8b5cf6;--orange:#f97316;
--text:#eaecef;--gray:#848e9c;--gray2:#5e6673;
--border:rgba(255,255,255,.07);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--gold);border-radius:4px}
input,button,textarea,select{font-family:'Space Grotesk',sans-serif;outline:none;border:none}
.mono{font-family:'JetBrains Mono',monospace}

@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideIn{from{transform:translateX(-8px);opacity:0}to{transform:none;opacity:1}}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@keyframes glow{0%,100%{box-shadow:0 0 15px rgba(240,185,11,.1)}50%{box-shadow:0 0 30px rgba(240,185,11,.25)}}
@keyframes typing{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes notifPop{0%{transform:scale(0) translateY(10px);opacity:0}60%{transform:scale(1.08)}100%{transform:scale(1) translateY(0);opacity:1}}

/* ====== LOGIN ====== */
#loginPage{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(240,185,11,.06),transparent)}
.login-box{background:var(--bg2);border:1px solid rgba(240,185,11,.2);border-radius:20px;padding:32px;width:100%;max-width:360px;animation:fadeIn .5s ease;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.login-icon{width:64px;height:64px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:16px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:#000;animation:glow 3s infinite}
.login-box h1{text-align:center;font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.login-box p{text-align:center;font-size:10px;color:var(--gray);letter-spacing:2px;margin-bottom:24px}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:10px;color:var(--gray);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.fg input{width:100%;padding:12px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;transition:.2s}
.fg input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(240,185,11,.08)}
.login-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;border:none;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;transition:.2s;margin-top:4px}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(240,185,11,.3)}
.login-btn:active{transform:scale(.97)}

/* ====== MAIN LAYOUT ====== */
#app{display:none;flex-direction:row;min-height:100vh}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:50;transition:.3s}
.sidebar-logo{padding:18px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.sidebar-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:#000;flex-shrink:0}
.sidebar-logo-text h2{font-size:14px;font-weight:700;color:var(--gold)}
.sidebar-logo-text p{font-size:8px;color:var(--gray);letter-spacing:1px}
.sidebar-nav{flex:1;padding:12px 8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:.2s;color:var(--gray);font-size:12px;font-weight:600;margin-bottom:2px;position:relative}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.on{background:linear-gradient(135deg,rgba(240,185,11,.15),rgba(240,185,11,.05));color:var(--gold);border:1px solid rgba(240,185,11,.15)}
.nav-item svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8;flex-shrink:0}
.nav-badge{position:absolute;right:10px;background:var(--red);color:#fff;font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;animation:pulse 1.5s infinite}
.sidebar-footer{padding:12px 8px;border-top:1px solid var(--border)}
.admin-info{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg3);border-radius:10px}
.admin-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:#000;flex-shrink:0}
.admin-info .ai-name{font-size:11px;font-weight:700}
.admin-info .ai-role{font-size:8px;color:var(--gold);font-weight:600}
.logout-btn{display:flex;align-items:center;gap:8px;width:100%;padding:9px 12px;background:rgba(246,70,93,.08);border:1px solid rgba(246,70,93,.15);border-radius:8px;color:var(--red);font-size:11px;font-weight:700;cursor:pointer;margin-top:8px;transition:.2s}
.logout-btn:hover{background:rgba(246,70,93,.15)}
.logout-btn svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}

.main{margin-left:240px;flex:1;min-height:100vh;display:flex;flex-direction:column}
.top-bar{background:rgba(6,8,14,.96);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(20px);position:sticky;top:0;z-index:40}
.top-bar h1{font-size:16px;font-weight:700}
.top-bar-r{display:flex;align-items:center;gap:12px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
.status-label{font-size:10px;color:var(--green);font-weight:700}
.live-time{font-size:10px;color:var(--gray);font-family:'JetBrains Mono',monospace}

.content{flex:1;padding:20px;overflow-y:auto}
.section{display:none;animation:fadeIn .3s ease}
.section.on{display:block}

/* STATS CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;overflow:hidden;cursor:pointer;transition:.2s}
.stat-card:hover{border-color:rgba(240,185,11,.2);transform:translateY(-2px)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.gold::before{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.stat-card.green::before{background:var(--green)}
.stat-card.red::before{background:var(--red)}
.stat-card.blue::before{background:var(--blue)}
.stat-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:10px}
.stat-card.gold .stat-icon{background:rgba(240,185,11,.12)}
.stat-card.green .stat-icon{background:rgba(14,203,129,.12)}
.stat-card.red .stat-icon{background:rgba(246,70,93,.12)}
.stat-card.blue .stat-icon{background:rgba(59,130,246,.12)}
.stat-val{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:2px}
.stat-card.gold .stat-val{color:var(--gold)}
.stat-card.green .stat-val{color:var(--green)}
.stat-card.red .stat-val{color:var(--red)}
.stat-card.blue .stat-val{color:var(--blue)}
.stat-label{font-size:9px;color:var(--gray);text-transform:uppercase;letter-spacing:.5px;font-weight:600}

/* TABLES */
.table-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px}
.table-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
.table-head h3{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.table-head .th-actions{display:flex;gap:8px}
.t-btn{padding:6px 14px;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;transition:.2s;border:none}
.t-btn.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.t-btn.green{background:rgba(14,203,129,.15);border:1px solid rgba(14,203,129,.2);color:var(--green)}
.t-btn.red{background:rgba(246,70,93,.15);border:1px solid rgba(246,70,93,.2);color:var(--red)}
.t-btn.blue{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.2);color:var(--blue)}
.t-btn.gray{background:var(--bg3);border:1px solid var(--border);color:var(--gray)}
.t-btn:hover{filter:brightness(1.15)}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:9px 14px;font-size:9px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:.5px;background:var(--bg3);border-bottom:1px solid var(--border)}
td{padding:11px 14px;font-size:11px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
tr:hover td{background:rgba(255,255,255,.015)}
tr:last-child td{border-bottom:none}
.user-cell{display:flex;align-items:center;gap:8px}
.user-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:#000;flex-shrink:0}
.user-cell .un{font-weight:700;font-size:11px}
.user-cell .ue{font-size:9px;color:var(--gray)}
.badge{display:inline-block;padding:2px 8px;border-radius:8px;font-size:9px;font-weight:700}
.badge-green{background:rgba(14,203,129,.15);color:var(--green)}
.badge-red{background:rgba(246,70,93,.15);color:var(--red)}
.badge-gold{background:rgba(240,185,11,.15);color:var(--gold)}
.badge-blue{background:rgba(59,130,246,.15);color:var(--blue)}
.badge-gray{background:var(--bg3);color:var(--gray)}
.action-btns{display:flex;gap:5px}
.act-btn{padding:4px 10px;border-radius:6px;font-size:9px;font-weight:700;cursor:pointer;border:none;transition:.15s}
.act-btn:active{transform:scale(.93)}

/* CHAT */
.chat-layout{display:grid;grid-template-columns:280px 1fr;gap:0;background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;height:calc(100vh - 180px);min-height:500px}
.chat-list{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.chat-list-head{padding:14px;border-bottom:1px solid var(--border);background:var(--bg3)}
.chat-list-head h3{font-size:13px;font-weight:700;margin-bottom:8px}
.chat-search{display:flex;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:0 10px;gap:6px}
.chat-search svg{width:14px;height:14px;stroke:var(--gray2);fill:none;flex-shrink:0}
.chat-search input{flex:1;background:none;border:none;padding:8px 4px;color:var(--text);font-size:11px}
.chat-user-list{flex:1;overflow-y:auto}
.chat-user-item{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;transition:.15s;border-bottom:1px solid rgba(255,255,255,.03);position:relative}
.chat-user-item:hover{background:var(--bg3)}
.chat-user-item.on{background:linear-gradient(90deg,rgba(240,185,11,.1),rgba(240,185,11,.03));border-left:2px solid var(--gold)}
.cui-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#000;flex-shrink:0;background:linear-gradient(135deg,var(--gold),var(--gold2))}
.cui-info{flex:1;min-width:0}
.cui-name{font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cui-preview{font-size:9px;color:var(--gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.cui-time{font-size:8px;color:var(--gray2);flex-shrink:0}
.cui-unread{position:absolute;right:10px;top:10px;background:var(--red);color:#fff;font-size:8px;font-weight:700;padding:2px 5px;border-radius:8px;min-width:16px;text-align:center}
.chat-main{display:flex;flex-direction:column;overflow:hidden}
.chat-top{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg3);flex-shrink:0}
.chat-top .ct-av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--blue),#6366f1);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.ct-info{flex:1}
.ct-name{font-size:13px;font-weight:700}
.ct-status{font-size:9px;color:var(--green)}
.ct-email{font-size:9px;color:var(--gray)}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.chat-msg{max-width:78%;animation:msgIn .25s ease}
.chat-msg.admin{align-self:flex-end}
.chat-msg.user{align-self:flex-start}
.msg-bub{padding:10px 14px;border-radius:14px;font-size:12px;line-height:1.5}
.admin .msg-bub{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;border-radius:14px 14px 4px 14px;font-weight:600}
.user .msg-bub{background:var(--bg3);border:1px solid var(--border);border-radius:14px 14px 14px 4px}
.msg-meta{font-size:8px;color:var(--gray2);margin-top:3px}
.admin .msg-meta{text-align:right}
.chat-input{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.chat-input textarea{flex:1;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:12px;resize:none;height:42px;line-height:1.4}
.chat-input textarea:focus{border-color:var(--gold);outline:none}
.chat-send{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:.2s}
.chat-send:hover{transform:scale(1.05)}
.chat-send svg{width:18px;height:18px;stroke:#000;fill:none;stroke-width:2}
.chat-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--gray);gap:10px}
.chat-empty .ce-icon{font-size:40px}
.chat-empty p{font-size:12px}

/* MODAL */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-ov.on{display:flex}
.modal-box{background:var(--bg2);border:1px solid rgba(240,185,11,.2);border-radius:16px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;animation:fadeIn .3s ease}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2);z-index:2}
.modal-head h3{font-size:14px;font-weight:700}
.modal-x{width:28px;height:28px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:.2s}
.modal-x:hover{background:var(--red);border-color:var(--red)}
.modal-body{padding:16px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:11px}
.info-row .ir-l{color:var(--gray);font-weight:600}
.info-row .ir-v{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:10px;text-align:right;word-break:break-all;max-width:55%}
.edit-bal-row{display:flex;gap:8px;margin-bottom:10px}
.edit-bal-row input{flex:1;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px}
.edit-bal-row input:focus{border-color:var(--gold)}
.edit-bal-row button{padding:9px 14px;background:var(--gold);color:#000;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap}

/* TOAST */
.toast{position:fixed;top:20px;right:20px;z-index:9999;padding:11px 18px;border-radius:10px;font-size:11px;font-weight:700;transition:.3s;transform:translateX(120px);box-shadow:0 8px 30px rgba(0,0,0,.4);max-width:280px}
.toast.on{transform:none}
.t-ok{background:var(--green);color:#fff}
.t-err{background:var(--red);color:#fff}
.t-info{background:var(--gold);color:#000}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--gray);gap:8px;text-align:center}
.empty-state .es-icon{font-size:36px}
.empty-state p{font-size:12px}

.filter-bar{display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg3)}
.filter-bar input{flex:1;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:11px}
.filter-bar input:focus{border-color:var(--gold);outline:none}
.filter-bar select{padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:11px}

/* NOTIFICATION PANEL */
.notif-panel{position:fixed;top:60px;right:20px;z-index:150;width:320px;background:var(--bg2);border:1px solid rgba(240,185,11,.2);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:none;animation:fadeIn .3s ease}
.notif-panel.on{display:block}
.notif-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.notif-head h4{font-size:12px;font-weight:700}
.notif-list{max-height:350px;overflow-y:auto}
.notif-item{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;transition:.15s;animation:notifPop .3s ease}
.notif-item:hover{background:var(--bg3)}
.notif-item.new{border-left:3px solid var(--gold)}
.notif-icon{font-size:20px;float:left;margin-right:10px}
.notif-title{font-size:11px;font-weight:700;margin-bottom:2px}
.notif-desc{font-size:9px;color:var(--gray);line-height:1.4}
.notif-time{font-size:8px;color:var(--gray2);margin-top:3px}
.notif-btn{width:32px;height:32px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;position:relative;transition:.2s}
.notif-btn:hover{background:var(--bg4)}
.notif-count{position:absolute;top:-3px;right:-3px;background:var(--red);color:#fff;font-size:7px;font-weight:700;padding:1px 4px;border-radius:6px;min-width:14px;text-align:center;animation:pulse 1.5s infinite}

/* CODE HIGHLIGHT BOX */
.code-box{background:var(--bg3);border:1px solid var(--gold);border-radius:8px;padding:10px;font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--gold);text-align:center;letter-spacing:8px;margin:8px 0;cursor:pointer;transition:.2s}
.code-box:hover{background:rgba(240,185,11,.1)}

@media(max-width:768px){
.sidebar{width:60px;overflow:hidden}
.sidebar-logo-text,.nav-item span,.admin-info .ai-name,.admin-info .ai-role,.logout-btn span{display:none}
.nav-item{justify-content:center;padding:12px}
.main{margin-left:60px}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.chat-layout{grid-template-columns:1fr}
.chat-list{display:none}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="login-box">
<div class="login-icon">üõ°Ô∏è</div>
<h1>Delta Admin Panel</h1>
<p>SUPPORT DASHBOARD v3.0</p>
<div class="fg"><label>Admin ID</label><input type="text" id="adId" placeholder="Enter admin ID"></div>
<div class="fg"><label>Password</label><input type="password" id="adPw" placeholder="Enter password" onkeydown="if(event.key==='Enter')doAdminLogin()"></div>
<button class="login-btn" onclick="doAdminLogin()">üîê Access Dashboard</button>
</div>
</div>

<!-- APP -->
<div id="app" style="display:none;flex">
<!-- SIDEBAR -->
<div class="sidebar">
<div class="sidebar-logo">
<div class="sidebar-logo-icon">Œî</div>
<div class="sidebar-logo-text"><h2>Delta Admin</h2><p>SUPPORT PANEL</p></div>
</div>
<div class="sidebar-nav">
<div class="nav-item on" onclick="goSec('dashboard',this)">
<svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
<span>Dashboard</span>
</div>
<div class="nav-item" onclick="goSec('chats',this)" id="navChats">
<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
<span>Live Chats</span>
<div class="nav-badge" id="chatBadge" style="display:none">0</div>
</div>
<div class="nav-item" onclick="goSec('tickets',this)" id="navTickets">
<svg viewBox="0 0 24 24"><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6"/><path d="M15 3h6v6"/><path d="m10 14 11-11"/></svg>
<span>Tickets</span>
<div class="nav-badge" id="ticketBadge" style="display:none">0</div>
</div>
<div class="nav-item" onclick="goSec('users',this)" id="navUsers">
<svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
<span>All Users</span>
<div class="nav-badge" id="userBadge" style="display:none">0</div>
</div>
<div class="nav-item" onclick="goSec('deposits',this)">
<svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
<span>Deposits</span>
<div class="nav-badge" id="depBadge" style="display:none">0</div>
</div>
<div class="nav-item" onclick="goSec('withdrawals',this)">
<svg viewBox="0 0 24 24"><path d="M21 12H3M3 12l9-9M3 12l9 9"/></svg>
<span>Withdrawals</span>
<div class="nav-badge" id="wdBadge" style="display:none">0</div>
</div>
</div>
<div class="sidebar-footer">
<div class="admin-info">
<div class="admin-av">A</div>
<div><div class="ai-name">Admin #7701</div><div class="ai-role">‚óè SUPER ADMIN</div></div>
</div>
<button class="logout-btn" onclick="doLogout()">
<svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
<span>Logout</span>
</button>
</div>
</div>

<!-- MAIN -->
<div class="main">
<div class="top-bar">
<h1 id="pageTitle">Dashboard</h1>
<div class="top-bar-r">
<div style="position:relative">
<button class="notif-btn" id="notifBtn" onclick="toggleNotifPanel()">üîî<span class="notif-count" id="notifCount" style="display:none">0</span></button>
<div class="notif-panel" id="notifPanel">
<div class="notif-head"><h4>üîî Notifications</h4><button onclick="clearNotifs()" style="background:none;border:none;color:var(--gray);font-size:10px;cursor:pointer">Clear all</button></div>
<div class="notif-list" id="notifList"></div>
</div>
</div>
<div class="status-dot"></div>
<span class="status-label">LIVE</span>
<span class="live-time" id="liveTime">--:--:--</span>
</div>
</div>

<div class="content">

<!-- DASHBOARD -->
<div class="section on" id="sec_dashboard">
<div class="stats-grid" id="statsGrid"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="table-card">
<div class="table-head"><h3>üë• New Users</h3><button class="t-btn gold" onclick="goSec('users',null)">View All</button></div>
<div id="recentUsers"></div>
</div>
<div class="table-card">
<div class="table-head"><h3>üí∞ Pending Deposits</h3><button class="t-btn gold" onclick="goSec('deposits',null)">View All</button></div>
<div id="recentDeposits"></div>
</div>
</div>
<div style="margin-top:16px" class="table-card">
<div class="table-head"><h3>üìã Recent Activity</h3><button class="t-btn gray" onclick="refreshAll()">üîÑ Refresh</button></div>
<div id="recentActivity"></div>
</div>
</div>

<!-- LIVE CHATS -->
<div class="section" id="sec_chats">
<div class="chat-layout">
<div class="chat-list">
<div class="chat-list-head">
<h3>üí¨ Customer Chats</h3>
<div class="chat-search">
<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
<input type="text" id="chatSearchInput" placeholder="Search users..." oninput="renderChatList()">
</div>
</div>
<div class="chat-user-list" id="chatUserList"></div>
</div>
<div class="chat-main" id="chatMain">
<div class="chat-empty"><div class="ce-icon">üí¨</div><p>Select a chat to start replying</p></div>
</div>
</div>
</div>

<!-- TICKETS -->
<div class="section" id="sec_tickets">
<div class="table-card">
<div class="table-head">
<h3>üé´ Support Tickets</h3>
<div class="th-actions">
<button class="t-btn green" onclick="filterTickets('open')">Open</button>
<button class="t-btn gold" onclick="filterTickets('all')">All</button>
</div>
</div>
<div id="ticketsList"></div>
</div>
</div>

<!-- USERS -->
<div class="section" id="sec_users">
<div class="table-card">
<div class="table-head"><h3>üë• All Users</h3><div class="th-actions"><button class="t-btn gray" onclick="renderUsers()">üîÑ Refresh</button></div></div>
<div class="filter-bar">
<input type="text" id="userSearch" placeholder="Search by name or email..." oninput="renderUsers()">
</div>
<div id="usersList"></div>
</div>
</div>

<!-- DEPOSITS -->
<div class="section" id="sec_deposits">
<div class="table-card">
<div class="table-head"><h3>üí∞ Deposit Requests</h3><button class="t-btn gray" onclick="renderDeposits()">üîÑ Refresh</button></div>
<div id="depositsList"></div>
</div>
</div>

<!-- WITHDRAWALS -->
<div class="section" id="sec_withdrawals">
<div class="table-card">
<div class="table-head"><h3>üì§ Withdrawal Requests</h3><button class="t-btn gray" onclick="renderWithdrawals()">üîÑ Refresh</button></div>
<div id="withdrawalsList"></div>
</div>
</div>

</div>
</div>
</div>

<!-- USER DETAIL MODAL -->
<div class="modal-ov" id="userModal" onclick="if(event.target===this)closeModal('userModal')">
<div class="modal-box">
<div class="modal-head"><h3>üë§ User Details</h3><button class="modal-x" onclick="closeModal('userModal')">‚úï</button></div>
<div class="modal-body" id="userModalBody"></div>
</div>
</div>

<!-- TICKET DETAIL MODAL -->
<div class="modal-ov" id="ticketModal" onclick="if(event.target===this)closeModal('ticketModal')">
<div class="modal-box">
<div class="modal-head"><h3>üé´ Ticket Details</h3><button class="modal-x" onclick="closeModal('ticketModal')">‚úï</button></div>
<div class="modal-body" id="ticketModalBody"></div>
</div>
</div>

<!-- DEP CODE MODAL -->
<div class="modal-ov" id="depCodeModal" onclick="if(event.target===this)closeModal('depCodeModal')">
<div class="modal-box">
<div class="modal-head"><h3>üîë Deposit Confirmation Code</h3><button class="modal-x" onclick="closeModal('depCodeModal')">‚úï</button></div>
<div class="modal-body" id="depCodeModalBody"></div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
var ADMIN_CREDS={id:'7701',pw:'xx7701'};
var INR_RATE=83.5;
var PLANS=[{id:1,name:'Starter',price:70,bonus:20,daily:15},{id:2,name:'Bronze',price:180,bonus:60,daily:50},{id:3,name:'Silver',price:500,bonus:100,daily:140},{id:4,name:'Gold',price:1010,bonus:300,daily:280},{id:5,name:'Platinum',price:3000,bonus:1000,daily:830},{id:6,name:'Diamond',price:10000,bonus:4000,daily:2780}];

var selChatUser=null,ticketFilter='all';
var seenNotifs=[];

function LS(k,v){if(v===undefined){try{return JSON.parse(localStorage.getItem(k))}catch(e){return null}}if(v===null){localStorage.removeItem(k);return}localStorage.setItem(k,JSON.stringify(v))}
function now(){return new Date().toLocaleString()}
function fmtTime(iso){try{return new Date(iso).toLocaleString()}catch(e){return '--'}}
function escHtml(s){return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'):''}

function doAdminLogin(){
var id=document.getElementById('adId').value.trim();
var pw=document.getElementById('adPw').value.trim();
if(id===ADMIN_CREDS.id&&pw===ADMIN_CREDS.pw){
document.getElementById('loginPage').style.display='none';
document.getElementById('app').style.display='flex';
startAdmin();toast('Welcome back, Admin!','ok');
}else toast('Invalid credentials','err');
}
function doLogout(){location.reload()}

function startAdmin(){
startClock();
refreshAll();
setInterval(refreshAll,5000); // Poll every 5s for real-time updates
}

function startClock(){
setInterval(function(){
var d=new Date();document.getElementById('liveTime').textContent=d.toLocaleTimeString();
},1000);
}

function refreshAll(){
checkAdminEvents();
renderDashboard();
renderChatList();
renderBadges();
if(selChatUser)renderChatMessages(selChatUser);
}

function goSec(s,el){
document.querySelectorAll('.section').forEach(function(x){x.classList.remove('on')});
document.querySelectorAll('.nav-item').forEach(function(x){x.classList.remove('on')});
document.getElementById('sec_'+s).classList.add('on');
if(el)el.classList.add('on');
var titles={dashboard:'Dashboard',chats:'Live Chats',tickets:'Support Tickets',users:'All Users',deposits:'Deposit Requests',withdrawals:'Withdrawal Requests'};
document.getElementById('pageTitle').textContent=titles[s]||s;
if(s==='chats')renderChatList();
if(s==='tickets')renderTickets();
if(s==='users')renderUsers();
if(s==='deposits')renderDeposits();
if(s==='withdrawals')renderWithdrawals();
}

// ===== ADMIN EVENTS (API bridge with Delta Exchange) =====
function checkAdminEvents(){
var events=LS('delta_admin_events')||[];
var newOnes=[];
for(var i=0;i<events.length;i++){
var ev=events[i];
if(!ev.processed&&seenNotifs.indexOf(ev.at)<0){
seenNotifs.push(ev.at);
newOnes.push(ev);
ev.processed=true;
processEvent(ev);
}
}
if(newOnes.length){
LS('delta_admin_events',events);
showNotifications(newOnes);
renderBadges();
}
}

function processEvent(ev){
var t=ev.type;var d=ev.data;
if(t==='new_user'){
toast('üÜï New user: '+d.name,'info');
}else if(t==='deposit_request'){
toast('üì• Deposit request: '+d.userName+' - $'+d.plan.price,'info');
}else if(t==='withdrawal_request'){
toast('üì§ Withdrawal: '+d.name+' - $'+d.amount,'info');
}else if(t==='chat_message'){
toast('üí¨ New message from '+d.userName,'info');
var badge=document.getElementById('chatBadge');
if(badge){badge.style.display='block';badge.textContent=parseInt(badge.textContent||'0')+1}
}else if(t==='ticket_submitted'){
toast('üé´ New ticket from '+d.name,'info');
}
}

function showNotifications(events){
var stored=LS('delta_notifs')||[];
for(var i=0;i<events.length;i++){stored.push({ev:events[i],at:new Date().toISOString(),new:true})}
if(stored.length>50)stored=stored.slice(-50);
LS('delta_notifs',stored);
renderNotifPanel();
}

function renderNotifPanel(){
var notifs=LS('delta_notifs')||[];
var unread=notifs.filter(function(n){return n.new}).length;
var nc=document.getElementById('notifCount');
nc.textContent=unread;nc.style.display=unread?'block':'none';
var icons={new_user:'üë§',deposit_request:'üí∞',withdrawal_request:'üì§',chat_message:'üí¨',ticket_submitted:'üé´',deposit_completed:'‚úÖ'};
var h='';
for(var i=notifs.length-1;i>=0;i--){
var n=notifs[i];var t=n.ev.type;var d=n.ev.data;
var icon=icons[t]||'üîî';
var title='',desc='';
if(t==='new_user'){title='New User Registered';desc='Name: '+d.name+' | Email: '+d.email}
else if(t==='deposit_request'){title='Deposit Request';desc='User: '+d.userName+' | Plan: '+d.plan.name+' $'+d.plan.price+' | Code: '+d.code}
else if(t==='withdrawal_request'){title='Withdrawal Request';desc='User: '+d.name+' | $'+d.amount+' via '+d.method}
else if(t==='chat_message'){title='New Chat Message';desc='From: '+d.userName+' ‚Äî '+d.text.substring(0,40)}
else if(t==='ticket_submitted'){title='New Support Ticket';desc='From: '+d.name+' | '+d.sub}
else if(t==='deposit_completed'){title='Deposit Completed';desc='User: '+d.name+' | $'+d.amount}
h+='<div class="notif-item'+(n.new?' new':'')+'">';
h+='<span class="notif-icon">'+icon+'</span>';
h+='<div style="overflow:hidden"><div class="notif-title">'+title+'</div><div class="notif-desc">'+desc+'</div><div class="notif-time">'+fmtTime(n.at)+'</div></div>';
h+='</div>';
}
if(!h)h='<div style="padding:20px;text-align:center;font-size:11px;color:var(--gray)">No notifications yet</div>';
document.getElementById('notifList').innerHTML=h;
}

function toggleNotifPanel(){
var p=document.getElementById('notifPanel');p.classList.toggle('on');
if(p.classList.contains('on')){
// Mark all as read
var notifs=LS('delta_notifs')||[];
for(var i=0;i<notifs.length;i++)notifs[i].new=false;
LS('delta_notifs',notifs);
document.getElementById('notifCount').style.display='none';
renderNotifPanel();
}
}

function clearNotifs(){LS('delta_notifs',null);renderNotifPanel();document.getElementById('notifPanel').classList.remove('on')}

// Close notif panel when clicking elsewhere
document.addEventListener('click',function(e){
var p=document.getElementById('notifPanel');var btn=document.getElementById('notifBtn');
if(p&&p.classList.contains('on')&&!p.contains(e.target)&&!btn.contains(e.target))p.classList.remove('on');
});

/* ============ DASHBOARD ============ */
function renderDashboard(){
var users=LS('delta_users')||[];
var wds=LS('delta_wds')||[];
var tickets=LS('delta_tickets')||[];
var pendingWds=wds.filter(function(w){return w.status.indexOf('pending')>=0}).length;
var openTickets=tickets.filter(function(t){return t.status==='open'}).length;
var totalBal=0;
for(var i=0;i<users.length;i++){var w=getW(users[i].id);totalBal+=(w.main+w.bonus)}
var pendingDeps=(LS('delta_deps')||[]).filter(function(d){return d.status==='pending'}).length;

document.getElementById('statsGrid').innerHTML=
'<div class="stat-card gold" onclick="goSec(\'users\',document.querySelectorAll(\'.nav-item\')[3])"><div class="stat-icon">üë•</div><div class="stat-val">'+users.length+'</div><div class="stat-label">Total Users</div></div>'+
'<div class="stat-card green"><div class="stat-icon">üí∞</div><div class="stat-val">$'+totalBal.toFixed(0)+'</div><div class="stat-label">Total Balance</div></div>'+
'<div class="stat-card red" onclick="goSec(\'withdrawals\',document.querySelectorAll(\'.nav-item\')[5])"><div class="stat-icon">üì§</div><div class="stat-val">'+pendingWds+'</div><div class="stat-label">Pending Withdrawals</div></div>'+
'<div class="stat-card blue" onclick="goSec(\'deposits\',document.querySelectorAll(\'.nav-item\')[4])"><div class="stat-icon">üí∞</div><div class="stat-val">'+pendingDeps+'</div><div class="stat-label">Pending Deposits</div></div>';

// Recent new users
var ruh='';
var recentUs=users.slice(-5).reverse();
if(!recentUs.length){ruh='<div class="empty-state"><div class="es-icon">üë•</div><p>No users yet</p></div>'}
else{ruh='<div style="padding:8px">';for(var i=0;i<recentUs.length;i++){var u=recentUs[i];ruh+='<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;transition:.15s" onmouseover="this.style.background=\'var(--bg3)\'" onmouseout="this.style.background=\'\'" onclick="openUserModal(\''+u.id+'\')"><div class="user-av">'+u.name.charAt(0).toUpperCase()+'</div><div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:700">'+escHtml(u.name)+'</div><div style="font-size:9px;color:var(--gray)">'+escHtml(u.email)+'</div></div><div style="font-size:8px;color:var(--gray)">'+fmtTime(u.created)+'</div></div>'}ruh+='</div>'}
document.getElementById('recentUsers').innerHTML=ruh;

// Pending deposits
var deps=LS('delta_deps')||[];var pendDeps=deps.filter(function(d){return d.status==='pending'});
var rdh='';
if(!pendDeps.length){rdh='<div class="empty-state"><div class="es-icon">üí∞</div><p>No pending deposits</p></div>'}
else{rdh='<div style="padding:8px">';for(var i=0;i<Math.min(5,pendDeps.length);i++){var d=pendDeps[i];rdh+='<div style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;transition:.15s" onclick="showDepCode(\''+d.id+'\')" onmouseover="this.style.background=\'var(--bg3)\'" onmouseout="this.style.background=\'\'"><div style="width:28px;height:28px;border-radius:50%;background:rgba(240,185,11,.15);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">üí∞</div><div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:700">'+escHtml(d.userName||'-')+'</div><div style="font-size:9px;color:var(--gray)">'+escHtml(d.plan?d.plan.name:'-')+' ‚Äî $'+(d.plan?d.plan.price:0)+'</div></div><div class="code-box" style="font-size:13px;padding:4px 8px;letter-spacing:4px;min-width:80px;text-align:center">'+d.code+'</div></div>'}rdh+='</div>'}
document.getElementById('recentDeposits').innerHTML=rdh;

// Recent activity
var events=LS('delta_admin_events')||[];var rah='';
if(!events.length){rah='<div class="empty-state"><div class="es-icon">üìã</div><p>No activity yet</p></div>'}
else{
var icons={new_user:'üë§',deposit_request:'üí∞',withdrawal_request:'üì§',chat_message:'üí¨',ticket_submitted:'üé´',deposit_completed:'‚úÖ'};
var labels={new_user:'New User',deposit_request:'Deposit Request',withdrawal_request:'Withdrawal',chat_message:'Chat Message',ticket_submitted:'Support Ticket',deposit_completed:'Deposit Completed'};
rah='<table><thead><tr><th>Event</th><th>User</th><th>Details</th><th>Time</th><th>Action</th></tr></thead><tbody>';
for(var i=events.length-1;i>=Math.max(0,events.length-15);i--){
var ev=events[i];var d=ev.data;var icon=icons[ev.type]||'üìã';
var detail='';
if(ev.type==='deposit_request')detail='$'+(d.plan?d.plan.price:'-')+' ‚Äî Code: <span style="font-family:JetBrains Mono,monospace;color:var(--gold);font-weight:700">'+d.code+'</span>';
else if(ev.type==='withdrawal_request')detail='$'+d.amount+' via '+d.method;
else if(ev.type==='chat_message')detail=(d.text||'').substring(0,35);
else if(ev.type==='ticket_submitted')detail=(d.sub||'').substring(0,35);
else if(ev.type==='new_user')detail='Email: '+d.email;
rah+='<tr><td><span class="badge badge-blue">'+icon+' '+(labels[ev.type]||ev.type)+'</span></td><td style="font-size:10px;font-weight:700">'+(d.name||d.userName||d.userEmail||'-')+'</td><td style="font-size:9px;color:var(--gray)">'+detail+'</td><td style="font-size:9px;color:var(--gray)">'+fmtTime(ev.at)+'</td><td>';
if(ev.type==='deposit_request')rah+='<button class="act-btn" style="background:rgba(240,185,11,.15);border:1px solid rgba(240,185,11,.2);color:var(--gold)" onclick="showDepCode(\''+d.id+'\')">üîë Code</button>';
else if(ev.type==='chat_message')rah+='<button class="act-btn" style="background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.2);color:var(--blue)" onclick="openChat(\''+d.userId+'\');goSec(\'chats\',document.querySelectorAll(\'.nav-item\')[1])">Chat</button>';
rah+='</td></tr>';
}
rah+='</tbody></table>'
}
document.getElementById('recentActivity').innerHTML=rah;
}

/* ============ DEPOSITS / CODE SYSTEM ============ */
function showDepCode(depId){
var deps=LS('delta_deps')||[];var d=deps.find(function(x){return x.id===depId});
// Also check pending_dep
var pd=LS('delta_pending_dep');
if(!d&&pd&&pd.id===depId)d=pd;
if(!d)return toast('Deposit not found','err');
var h='';
h+='<div style="text-align:center;margin-bottom:16px"><div style="font-size:32px;margin-bottom:8px">üîë</div><div style="font-size:14px;font-weight:700;color:var(--gold)">Deposit Confirmation Code</div><div style="font-size:10px;color:var(--gray);margin-top:3px">Share this code with the customer</div></div>';
h+='<div class="code-box" onclick="cpText(\''+d.code+'\')" title="Click to copy">'+(d.code||'N/A')+'</div>';
h+='<div style="font-size:9px;color:var(--gray);text-align:center;margin-bottom:12px">Click to copy ‚Ä¢ Customer enters this to confirm deposit</div>';
h+='<div class="info-row"><span class="ir-l">User</span><span class="ir-v">'+(d.userName||'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Email</span><span class="ir-v">'+(d.userEmail||'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Plan</span><span class="ir-v">'+(d.plan?d.plan.name:'-')+' ‚Äî $'+(d.plan?d.plan.price:'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Bonus</span><span class="ir-v" style="color:var(--green)">+$'+(d.plan?d.plan.bonus:'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Status</span><span class="ir-v"><span class="badge badge-'+(d.status==='pending'?'gold':'green')+'">'+d.status+'</span></span></div>';
h+='<div class="info-row"><span class="ir-l">Requested</span><span class="ir-v">'+fmtTime(d.at)+'</span></div>';
h+='<div style="margin-top:14px;display:flex;gap:8px">';
if(d.status==='pending'){
h+='<button class="t-btn green" style="flex:1" onclick="approveDep(\''+depId+'\')">‚úÖ Approve Deposit</button>';
}
h+='<button class="t-btn blue" style="flex:1" onclick="cpText(\''+d.code+'\')">üìã Copy Code</button>';
h+='</div>';
document.getElementById('depCodeModalBody').innerHTML=h;
document.getElementById('depCodeModal').classList.add('on');
}

/* ============ CHAT ============ */
function getChatUsers(){
var users=LS('delta_users')||[];var cu=[];
for(var i=0;i<users.length;i++){var msgs=LS('delta_chat_'+users[i].id)||[];if(msgs.length)cu.push(users[i])}
return cu;
}

function renderChatList(){
var q=(document.getElementById('chatSearchInput')?document.getElementById('chatSearchInput').value:'').toLowerCase();
var users=LS('delta_users')||[];
// Include all users (even without messages - for proactive chat)
var sorted=users.slice().sort(function(a,b){
var ma=LS('delta_chat_'+a.id)||[];var mb=LS('delta_chat_'+b.id)||[];
var la=ma.length?ma[ma.length-1].at:'';var lb=mb.length?mb[mb.length-1].at:'';
return lb.localeCompare(la);
});
if(q)sorted=sorted.filter(function(u){return u.name.toLowerCase().indexOf(q)>=0||u.email.toLowerCase().indexOf(q)>=0});
var h='';
for(var i=0;i<sorted.length;i++){
var u=sorted[i];var msgs=LS('delta_chat_'+u.id)||[];
var lastMsg=msgs.length?msgs[msgs.length-1]:{text:'No messages yet'};
var unread=msgs.filter(function(m){return m.role==='user'&&!m.read}).length;
var isOn=selChatUser===u.id;
h+='<div class="chat-user-item'+(isOn?' on':'')+'" onclick="openChat(\''+u.id+'\')"><div class="cui-av">'+u.name.charAt(0).toUpperCase()+'</div><div class="cui-info"><div class="cui-name">'+escHtml(u.name)+'</div><div class="cui-preview">'+escHtml((lastMsg.text||'').substring(0,38))+'</div></div><div class="cui-time">'+(lastMsg.at?new Date(lastMsg.at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'')+'</div>'+(unread?'<div class="cui-unread">'+unread+'</div>':'')+'</div>';
}
if(!h)h='<div class="empty-state"><div class="es-icon">üë•</div><p>No users yet</p></div>';
document.getElementById('chatUserList').innerHTML=h;
}

function openChat(uid){
selChatUser=uid;
var users=LS('delta_users')||[];var u=users.find(function(x){return x.id===uid});if(!u)return;
var w=getW(uid);
// Mark as read
var msgs=LS('delta_chat_'+uid)||[];
for(var i=0;i<msgs.length;i++){if(msgs[i].role==='user')msgs[i].read=true}
LS('delta_chat_'+uid,msgs);
renderChatList();
var h='<div class="chat-top"><div class="ct-av">'+u.name.charAt(0).toUpperCase()+'</div><div class="ct-info"><div class="ct-name">'+escHtml(u.name)+'</div><div class="ct-status">‚óè Active</div><div class="ct-email">'+escHtml(u.email)+' ‚Ä¢ Bal: $'+(w.main+w.bonus).toFixed(2)+'</div></div><div class="chat-top-actions" style="display:flex;gap:6px"><button class="act-btn" style="background:rgba(240,185,11,.15);border:1px solid rgba(240,185,11,.2);color:var(--gold)" onclick="openUserModal(\''+uid+'\')">üë§ Profile</button></div></div>';
h+='<div class="chat-messages" id="adminChatMsg_'+uid+'"></div>';
h+='<div class="chat-input"><textarea id="adminChatInput" placeholder="Reply to '+escHtml(u.name)+'..." onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendAdminMsg(\''+uid+'\')}"></textarea><button class="chat-send" onclick="sendAdminMsg(\''+uid+'\')"><svg viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4 20-7z"/></svg></button></div>';
document.getElementById('chatMain').innerHTML=h;
renderChatMessages(uid);
}

function renderChatMessages(uid){
var el=document.getElementById('adminChatMsg_'+uid);if(!el)return;
var msgs=LS('delta_chat_'+uid)||[];var h='';
if(!msgs.length){h='<div class="chat-empty"><div class="ce-icon">üí¨</div><p>No messages yet. Start the conversation!</p></div>'}
else{for(var i=0;i<msgs.length;i++){var m=msgs[i];var isAdmin=m.role==='admin';h+='<div class="chat-msg '+(isAdmin?'admin':'user')+'"><div class="msg-bub">'+escHtml(m.text)+'</div><div class="msg-meta">'+(isAdmin?'You':'Customer')+' ‚Ä¢ '+m.time+'</div></div>'}}
el.innerHTML=h;el.scrollTop=el.scrollHeight;
}

function sendAdminMsg(uid){
var inp=document.getElementById('adminChatInput');if(!inp)return;
var msg=inp.value.trim();if(!msg)return;
inp.value='';
var time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
var msgs=LS('delta_chat_'+uid)||[];
msgs.push({role:'admin',text:msg,time:time,at:new Date().toISOString(),read:true,shownToUser:false});
LS('delta_chat_'+uid,msgs);
renderChatMessages(uid);renderChatList();
toast('Reply sent!','ok');
}

function renderBadges(){
var users=LS('delta_users')||[];
var chatUsers=getChatUsers();
var unreadTotal=0;
for(var i=0;i<chatUsers.length;i++){var msgs=LS('delta_chat_'+chatUsers[i].id)||[];unreadTotal+=msgs.filter(function(m){return m.role==='user'&&!m.read}).length}
var cb=document.getElementById('chatBadge');cb.style.display=unreadTotal?'block':'none';cb.textContent=unreadTotal;

var tickets=LS('delta_tickets')||[];var openTk=tickets.filter(function(t){return t.status==='open'}).length;
var tb=document.getElementById('ticketBadge');tb.style.display=openTk?'block':'none';tb.textContent=openTk;

var deps=LS('delta_deps')||[];var pendDeps=deps.filter(function(d){return d.status==='pending'}).length;
var db=document.getElementById('depBadge');db.style.display=pendDeps?'block':'none';db.textContent=pendDeps;

var wds=LS('delta_wds')||[];var pendWds=wds.filter(function(w){return w.status.indexOf('pending')>=0}).length;
var wb=document.getElementById('wdBadge');wb.style.display=pendWds?'block':'none';wb.textContent=pendWds;

// New users badge
var events=LS('delta_admin_events')||[];var newUsers=events.filter(function(e){return e.type==='new_user'&&!e.processed}).length;
// Already processed so read from storage
var ub=document.getElementById('userBadge');ub.style.display='none';
}

/* ============ TICKETS ============ */
function renderTickets(){
var tickets=LS('delta_tickets')||[];
if(ticketFilter==='open')tickets=tickets.filter(function(t){return t.status==='open'});
var h='';
if(!tickets.length){h='<div class="empty-state"><div class="es-icon">üé´</div><p>No tickets '+(ticketFilter==='open'?'open':'found')+'</p></div>'}
else{h='<table><thead><tr><th>ID</th><th>User</th><th>Category</th><th>Subject</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
for(var i=tickets.length-1;i>=0;i--){var t=tickets[i];
h+='<tr><td class="mono" style="font-size:9px;color:var(--gray)">'+t.id+'</td>';
h+='<td><div class="user-cell"><div class="user-av">'+t.name.charAt(0).toUpperCase()+'</div><div><div class="un">'+escHtml(t.name)+'</div><div class="ue">'+escHtml(t.email)+'</div></div></div></td>';
h+='<td><span class="badge badge-blue">'+escHtml(t.cat||'General')+'</span></td>';
h+='<td style="max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:10px">'+escHtml(t.sub)+'</td>';
h+='<td><span class="badge badge-'+(t.status==='open'?'red':'green')+'">'+t.status+'</span></td>';
h+='<td style="font-size:9px;color:var(--gray)">'+fmtTime(t.at)+'</td>';
h+='<td><div class="action-btns"><button class="act-btn" style="background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.2);color:var(--blue)" onclick="openTicketDetail('+i+')">View</button>'+(t.status==='open'?'<button class="act-btn" style="background:rgba(14,203,129,.15);border:1px solid rgba(14,203,129,.2);color:var(--green)" onclick="closeTicketItem('+i+')">Close</button>':'')+'</div></td></tr>';
}h+='</tbody></table>'}
document.getElementById('ticketsList').innerHTML=h;
}
function filterTickets(f){ticketFilter=f;renderTickets()}

function openTicketDetail(idx){
var tks=LS('delta_tickets')||[];var t=tks[idx];if(!t)return;
var h='<div class="info-row"><span class="ir-l">ID</span><span class="ir-v mono">'+t.id+'</span></div>';
h+='<div class="info-row"><span class="ir-l">From</span><span class="ir-v">'+escHtml(t.name)+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Email</span><span class="ir-v">'+escHtml(t.email)+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Category</span><span class="ir-v">'+escHtml(t.cat||'General')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Subject</span><span class="ir-v">'+escHtml(t.sub)+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Status</span><span class="ir-v"><span class="badge badge-'+(t.status==='open'?'red':'green')+'">'+t.status+'</span></span></div>';
h+='<div class="info-row"><span class="ir-l">Date</span><span class="ir-v">'+fmtTime(t.at)+'</span></div>';
h+='<div style="margin:12px 0"><div style="font-size:10px;color:var(--gray);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Message</div><div style="background:var(--bg3);border-radius:10px;padding:12px;font-size:12px;color:var(--text);line-height:1.6">'+escHtml(t.msg)+'</div></div>';
if(t.status==='open'){
h+='<div style="margin-top:12px"><div style="font-size:10px;color:var(--gray);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Reply via Chat</div>';
h+='<button class="t-btn blue" style="width:100%;padding:10px;margin-bottom:8px" onclick="openChat(\''+t.userId+'\');goSec(\'chats\',document.querySelectorAll(\'.nav-item\')[1]);closeModal(\'ticketModal\')">üí¨ Open Chat with User</button>';
h+='<button class="t-btn red" style="width:100%;padding:10px" onclick="closeTicketItem('+idx+');closeModal(\'ticketModal\')">‚ùå Close Ticket</button>';
h+='</div>';
}
document.getElementById('ticketModalBody').innerHTML=h;
document.getElementById('ticketModal').classList.add('on');
}
function closeTicketItem(idx){var tks=LS('delta_tickets')||[];if(!tks[idx])return;tks[idx].status='closed';LS('delta_tickets',tks);renderTickets();renderDashboard();renderBadges();toast('Ticket closed','ok')}

/* ============ USERS ============ */
function renderUsers(){
var users=LS('delta_users')||[];
var q=(document.getElementById('userSearch')?document.getElementById('userSearch').value:'').toLowerCase();
if(q)users=users.filter(function(u){return u.name.toLowerCase().indexOf(q)>=0||u.email.toLowerCase().indexOf(q)>=0});
var h='';
if(!users.length){h='<div class="empty-state"><div class="es-icon">üë•</div><p>No users registered yet</p></div>'}
else{
h='<table><thead><tr><th>User</th><th>Contact</th><th>Balance</th><th>Plan</th><th>KYC</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
// Show newest first
var rev=users.slice().reverse();
for(var i=0;i<rev.length;i++){var u=rev[i];var w=getW(u.id);var bal=(w.main+w.bonus).toFixed(2);
h+='<tr'+(u.banned?' style="opacity:.5"':'')+'>';
h+='<td><div class="user-cell"><div class="user-av">'+u.name.charAt(0).toUpperCase()+'</div><div><div class="un">'+escHtml(u.name)+(u.banned?' üö´':'')+'</div><div class="ue mono" style="font-size:8px">'+u.id.slice(-10)+'</div></div></div></td>';
h+='<td><div class="ue">'+escHtml(u.email)+'</div><div class="ue">'+(u.phone||'-')+'</div></td>';
h+='<td><div class="mono" style="font-size:11px;font-weight:700;color:var(--gold)">$'+bal+'</div><div class="ue">‚Çπ'+Number((parseFloat(bal)*INR_RATE).toFixed(0)).toLocaleString('en-IN')+'</div></td>';
h+='<td>'+(u.plan?'<span class="badge badge-gold">'+PLANS[u.plan-1].name+'</span>':'<span class="badge badge-gray">None</span>')+'</td>';
h+='<td>'+(u.kyc?'<span class="badge badge-green">‚úÖ KYC</span>':'<span class="badge badge-red">‚ùå No KYC</span>')+'</td>';
h+='<td style="font-size:9px;color:var(--gray)">'+fmtTime(u.created)+'</td>';
h+='<td><div class="action-btns"><button class="act-btn" style="background:rgba(240,185,11,.15);border:1px solid rgba(240,185,11,.2);color:var(--gold)" onclick="openUserModal(\''+u.id+'\')">Edit</button><button class="act-btn" style="background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.2);color:var(--blue)" onclick="openChat(\''+u.id+'\');goSec(\'chats\',document.querySelectorAll(\'.nav-item\')[1])">Chat</button><button class="act-btn" style="background:'+(u.banned?'rgba(14,203,129,.15)':'rgba(246,70,93,.15)')+';border:1px solid '+(u.banned?'rgba(14,203,129,.2)':'rgba(246,70,93,.2)')+';color:'+(u.banned?'var(--green)':'var(--red)')+'" onclick="toggleBan(\''+u.id+'\')">'+( u.banned?'Unban':'Ban')+'</button></div></td></tr>';
}h+='</tbody></table>'
}
document.getElementById('usersList').innerHTML=h;
}

function openUserModal(uid){
var users=LS('delta_users')||[];var u=users.find(function(x){return x.id===uid});if(!u)return;
var w=getW(uid);
var h='<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:14px;background:var(--bg3);border-radius:12px">';
h+='<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#000;flex-shrink:0">'+u.name.charAt(0).toUpperCase()+'</div>';
h+='<div><div style="font-size:14px;font-weight:700">'+escHtml(u.name)+'</div><div style="font-size:10px;color:var(--gray)">'+escHtml(u.email)+'</div><div style="font-size:9px;color:var(--gold);font-weight:700;margin-top:2px">'+(u.plan?PLANS[u.plan-1].name+' Plan':'No Plan')+' ‚Ä¢ '+(u.kyc?'‚úÖ KYC':'‚ùå No KYC')+'</div></div></div>';
h+='<div class="info-row"><span class="ir-l">Phone</span><span class="ir-v">'+(u.phone||'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Age / City</span><span class="ir-v">'+(u.age||'-')+' / '+(u.city||'-')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Password</span><span class="ir-v mono" style="color:var(--red)">'+u.password+'</span></div>';
h+='<div class="info-row"><span class="ir-l">User ID</span><span class="ir-v mono" style="font-size:8px">'+u.id+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Referral</span><span class="ir-v">'+(u.refer||'None')+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Joined</span><span class="ir-v">'+fmtTime(u.created)+'</span></div>';
h+='<div class="info-row"><span class="ir-l">Banned</span><span class="ir-v"><span class="badge badge-'+(u.banned?'red':'green')+'">'+(u.banned?'Yes üö´':'No ‚úÖ')+'</span></span></div>';
h+='<div style="margin:14px 0 6px;font-size:10px;font-weight:700;color:var(--text)">üí∞ Edit Balance (USDT)</div>';
h+='<div class="edit-bal-row"><input type="number" id="em_main" value="'+w.main.toFixed(2)+'" placeholder="Main balance"><button onclick="saveBalFromModal(\''+uid+'\')">Save</button></div>';
h+='<div class="edit-bal-row"><input type="number" id="em_bonus" value="'+w.bonus.toFixed(2)+'" placeholder="Bonus"><button onclick="saveBalFromModal(\''+uid+'\')">Save</button></div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">';
h+='<button class="t-btn blue" onclick="openChat(\''+uid+'\');goSec(\'chats\',document.querySelectorAll(\'.nav-item\')[1]);closeModal(\'userModal\')">üí¨ Chat</button>';
h+='<button class="t-btn '+(u.banned?'green':'red')+'" onclick="toggleBan(\''+uid+'\');closeModal(\'userModal\')">'+(u.banned?'‚úÖ Unban':'üö´ Ban')+'</button>';
h+='</div>';
document.getElementById('userModalBody').innerHTML=h;
document.getElementById('userModal').classList.add('on');
}

function saveBalFromModal(uid){
var m=parseFloat(document.getElementById('em_main').value)||0;
var b=parseFloat(document.getElementById('em_bonus').value)||0;
setW(uid,{main:m,bonus:b});renderUsers();renderDashboard();closeModal('userModal');toast('Balance updated!','ok');
}
function toggleBan(uid){var us=LS('delta_users')||[];for(var i=0;i<us.length;i++){if(us[i].id===uid){us[i].banned=!us[i].banned;break}}LS('delta_users',us);renderUsers();renderDashboard();toast('Done','ok')}

/* ============ DEPOSITS ============ */
function renderDeposits(){
var deps=LS('delta_deps')||[];
var h='';
if(!deps.length){h='<div class="empty-state"><div class="es-icon">üí∞</div><p>No deposit requests yet</p></div>'}
else{
h='<table><thead><tr><th>ID</th><th>User</th><th>Plan</th><th>Amount</th><th>CONFIRM CODE</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
for(var i=deps.length-1;i>=0;i--){var d=deps[i];var isPend=d.status==='pending';
h+='<tr><td class="mono" style="font-size:9px;color:var(--gray)">'+(d.id||'-').slice(-12)+'</td>';
h+='<td><div class="user-cell"><div class="user-av">'+(d.userName||'?').charAt(0).toUpperCase()+'</div><div><div class="un">'+escHtml(d.userName||'-')+'</div><div class="ue">'+escHtml(d.userEmail||'-')+'</div></div></div></td>';
h+='<td style="font-size:10px">'+escHtml(d.plan?d.plan.name:'-')+'</td>';
h+='<td><span style="color:var(--gold);font-weight:700;font-family:JetBrains Mono,monospace">$'+(d.plan?d.plan.price:0)+'</span>'+(d.plan&&d.plan.bonus?'<br><span style="font-size:9px;color:var(--green)">+$'+d.plan.bonus+' bonus</span>':'')+'</td>';
// BIG VISIBLE CODE
h+='<td><div class="code-box" onclick="cpText(\''+d.code+'\')" title="Click to copy">'+d.code+'</div></td>';
h+='<td><span class="badge badge-'+(isPend?'gold':'green')+'">'+d.status+'</span></td>';
h+='<td style="font-size:9px;color:var(--gray)">'+fmtTime(d.at)+'</td>';
h+='<td><div class="action-btns">'+(isPend?'<button class="act-btn" style="background:rgba(14,203,129,.15);border:1px solid rgba(14,203,129,.2);color:var(--green)" onclick="approveDep(\''+d.id+'\')">‚úÖ Approve</button>':'<span class="badge badge-green">Done</span>')+'<button class="act-btn" style="background:rgba(240,185,11,.15);border:1px solid rgba(240,185,11,.2);color:var(--gold)" onclick="showDepCode(\''+d.id+'\')">üîë Code</button></div></td></tr>';
}h+='</tbody></table>'
}
document.getElementById('depositsList').innerHTML=h;
}

function approveDep(id){
var deps=LS('delta_deps')||[];var d=deps.find(function(x){return x.id===id});
if(!d)return toast('Not found','err');
var uid=d.userId;var plan=d.plan;
if(!plan)return toast('Invalid deposit data','err');
var w=getW(uid);w.main+=plan.price;w.bonus+=(plan.bonus||0);setW(uid,w);
var us=LS('delta_users')||[];
for(var i=0;i<us.length;i++){if(us[i].id===uid){var planIdx=PLANS.findIndex(function(p){return p.name===plan.name});us[i].plan=planIdx>=0?planIdx+1:1;us[i].kyc=true;break}}LS('delta_users',us);
var txns=LS('delta_txn_'+uid)||[];txns.push({type:'deposit',amt:plan.price+plan.bonus,st:'completed',at:new Date().toISOString()});LS('delta_txn_'+uid,txns);
for(var i=0;i<deps.length;i++){if(deps[i].id===id){deps[i].status='approved';break}}LS('delta_deps',deps);
if(LS('delta_pending_dep')&&LS('delta_pending_dep').id===id){var pd=LS('delta_pending_dep');pd.status='approved';LS('delta_pending_dep',pd)}
renderDeposits();renderDashboard();renderBadges();closeModal('depCodeModal');
toast('‚úÖ Deposit approved: +$'+(plan.price+plan.bonus),'ok');
}

/* ============ WITHDRAWALS ============ */
function renderWithdrawals(){
var wds=LS('delta_wds')||[];var h='';
if(!wds.length){h='<div class="empty-state"><div class="es-icon">üì§</div><p>No withdrawal requests</p></div>'}
else{h='<table><thead><tr><th>ID</th><th>User</th><th>Amount</th><th>Network</th><th>Address</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
for(var i=wds.length-1;i>=0;i--){var d=wds[i];var isPend=d.status.indexOf('pending')>=0;
h+='<tr><td class="mono" style="font-size:9px;color:var(--gray)">'+(d.id||'-').slice(-12)+'</td>';
h+='<td><div class="user-cell"><div class="user-av">'+(d.userName||'?').charAt(0).toUpperCase()+'</div><div><div class="un">'+escHtml(d.userName||'-')+'</div><div class="ue">'+escHtml(d.userEmail||'-')+'</div></div></div></td>';
h+='<td><span style="color:var(--red);font-weight:700;font-family:JetBrains Mono,monospace">-$'+d.amount.toFixed(2)+'</span><br><span style="font-size:9px;color:var(--gray)">Fee: $'+(d.fee||0)+'</span></td>';
h+='<td><span class="badge badge-blue">'+escHtml(d.method||'-')+'</span></td>';
h+='<td style="font-size:9px;color:var(--gray);max-width:120px;word-break:break-all">'+escHtml((d.addr||'-').substring(0,20))+'...</td>';
h+='<td><span class="badge badge-'+(isPend?'gold':'green')+'">'+d.status+'</span></td>';
h+='<td style="font-size:9px;color:var(--gray)">'+fmtTime(d.at)+'</td>';
h+='<td>'+(isPend?'<div class="action-btns"><button class="act-btn" style="background:rgba(14,203,129,.15);border:1px solid rgba(14,203,129,.2);color:var(--green)" onclick="approveWd('+i+')">‚úÖ Done</button><button class="act-btn" style="background:rgba(246,70,93,.15);border:1px solid rgba(246,70,93,.2);color:var(--red)" onclick="refundWd('+i+')">‚Ü© Refund</button></div>':'<span class="badge badge-green">Done</span>')+'</td></tr>';
}h+='</tbody></table>'}
document.getElementById('withdrawalsList').innerHTML=h;
}
function approveWd(idx){var wds=LS('delta_wds')||[];if(!wds[idx])return;wds[idx].status='completed';LS('delta_wds',wds);renderWithdrawals();renderDashboard();toast('Withdrawal completed','ok')}
function refundWd(idx){var wds=LS('delta_wds')||[];if(!wds[idx])return;var d=wds[idx];d.status='refunded';wds[idx]=d;LS('delta_wds',wds);var w=getW(d.userId);w.main+=d.amount+(d.fee||0);setW(d.userId,w);renderWithdrawals();renderDashboard();toast('Refunded $'+d.amount,'ok')}

/* ============ HELPERS ============ */
function getW(uid){var ws=LS('delta_wallets')||{};return ws[uid]||{main:0,bonus:0}}
function setW(uid,w){var ws=LS('delta_wallets')||{};ws[uid]=w;LS('delta_wallets',ws)}
function closeModal(id){document.getElementById(id).classList.remove('on')}
function cpText(t){if(navigator.clipboard)navigator.clipboard.writeText(t);else{var a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a)}toast('Code copied!','ok')}
function toast(msg,type){var el=document.getElementById('toast');el.textContent=msg;el.className='toast t-'+(type==='ok'?'ok':type==='err'?'err':'info')+' on';setTimeout(function(){el.classList.remove('on')},3500)}

document.addEventListener('DOMContentLoaded',function(){
var adId=document.getElementById('adId');if(adId)adId.focus();
});
</script>
</body>
</html>
